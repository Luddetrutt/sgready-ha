[
    {
        "id": "sgready-tab",
        "type": "tab",
        "label": "SG Ready â€“ ElmÃ¤tare",
        "disabled": false,
        "info": "Publicerar elmÃ¤tardata till Home Assistant via MQTT.\nKrÃ¤ver MQTT-broker konfigurerad i Node-RED.\n\nSteg:\n1. ErsÃ¤tt noden 'ðŸ”Œ Anslut elmÃ¤tare hÃ¤r' med din faktiska mÃ¤tarkÃ¤lla\n2. Se till att vÃ¤rdet Ã¤r i Watt (W) â€” negativt = export till nÃ¤t, positivt = import frÃ¥n nÃ¤t\n3. Deploya flÃ¶det â€” HA-sensorn skapas automatiskt via MQTT Discovery"
    },
    {
        "id": "sgready-comment-1",
        "type": "comment",
        "z": "sgready-tab",
        "name": "ðŸ“– Instruktioner",
        "info": "## SG Ready â€“ ElmÃ¤tare\n\nDetta flÃ¶de skapar en Home Assistant-sensor (via MQTT Discovery)\nsom SG Ready-integrationen anvÃ¤nder fÃ¶r produktions-override.\n\n### Steg fÃ¶r att komma igÃ¥ng:\n1. **ErsÃ¤tt** noden 'ðŸ”Œ Anslut elmÃ¤tare hÃ¤r' med din faktiska datakÃ¤lla\n   (t.ex. M-Bus, Modbus, Shelly EM, P1-lÃ¤sare, etc.)\n2. **Se till att vÃ¤rdet** Ã¤r ett tal i Watt:\n   - **Negativt** = du exporterar till elnÃ¤tet (solÃ¶verskott)\n   - **Positivt** = du importerar frÃ¥n elnÃ¤tet\n3. **Deploya** â€” HA-sensorn 'Grid Power' skapas automatiskt\n4. **VÃ¤lj sensorn** i SG Ready-konfigurationen under 'Grid power entity'\n\n### MQTT-topics som anvÃ¤nds:\n- `homeassistant/sensor/sgready_grid_power/config` (discovery, kÃ¶rs vid start)\n- `homeassistant/sensor/sgready_grid_power/state` (effektvÃ¤rde, lÃ¶pande)",
        "x": 160,
        "y": 60,
        "wires": []
    },
    {
        "id": "sgready-comment-2",
        "type": "comment",
        "z": "sgready-tab",
        "name": "â†“ KÃ¶rs en gÃ¥ng vid start â€” skapar HA-sensorn automatiskt",
        "info": "",
        "x": 290,
        "y": 160,
        "wires": []
    },
    {
        "id": "sgready-inject-discovery",
        "type": "inject",
        "z": "sgready-tab",
        "name": "Startup",
        "props": [
            { "p": "payload" },
            { "p": "topic", "vt": "str" }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 3,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 220,
        "wires": [["sgready-fn-discovery"]]
    },
    {
        "id": "sgready-fn-discovery",
        "type": "function",
        "z": "sgready-tab",
        "name": "Bygg discovery-payload",
        "func": "msg.topic = 'homeassistant/sensor/sgready_grid_power/config';\nmsg.payload = JSON.stringify({\n    name: 'Grid Power',\n    unique_id: 'sgready_grid_power',\n    state_topic: 'homeassistant/sensor/sgready_grid_power/state',\n    unit_of_measurement: 'W',\n    device_class: 'power',\n    state_class: 'measurement',\n    device: {\n        identifiers: ['sgready_grid_meter'],\n        name: 'SG Ready ElmÃ¤tare',\n        model: 'MQTT Bridge',\n        manufacturer: 'SG Ready'\n    }\n});\nmsg.retain = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 220,
        "wires": [["sgready-mqtt-discovery"]]
    },
    {
        "id": "sgready-mqtt-discovery",
        "type": "mqtt out",
        "z": "sgready-tab",
        "name": "MQTT Discovery â†’ HA",
        "topic": "",
        "qos": "1",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "",
        "x": 620,
        "y": 220,
        "wires": []
    },
    {
        "id": "sgready-comment-3",
        "type": "comment",
        "z": "sgready-tab",
        "name": "â†“ ErsÃ¤tt ðŸ”Œ-noden med din mÃ¤tarkÃ¤lla â€” output: msg.payload = watt (tal)",
        "info": "",
        "x": 300,
        "y": 320,
        "wires": []
    },
    {
        "id": "sgready-stub-meter",
        "type": "function",
        "z": "sgready-tab",
        "name": "ðŸ”Œ Anslut elmÃ¤tare hÃ¤r",
        "func": "// -------------------------------------------------------\n// ERSÃ„TT DENNA NOD med din faktiska mÃ¤tarkÃ¤lla\n// (M-Bus, Modbus, Shelly EM, P1-lÃ¤sare, etc.)\n//\n// Output-kravet:\n//   msg.payload = effekt i Watt (ett tal)\n//   Negativt = export till elnÃ¤t (solÃ¶verskott)\n//   Positivt = import frÃ¥n elnÃ¤t\n//\n// Exempel:\n//   msg.payload = -850;  // 850W solÃ¶verskott\n//   msg.payload = 320;   // 320W frÃ¥n elnÃ¤tet\n// -------------------------------------------------------\n\n// Placeholder â€” ta bort och ersÃ¤tt med riktig kÃ¤lla:\nnode.warn('âš ï¸ Anslut din elmÃ¤tare! Se kommentaren i noden.');\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 180,
        "y": 400,
        "wires": [["sgready-fn-validate"]]
    },
    {
        "id": "sgready-fn-validate",
        "type": "function",
        "z": "sgready-tab",
        "name": "Validera & formatera",
        "func": "// Kontrollera att payload Ã¤r ett giltigt tal\nconst val = parseFloat(msg.payload);\nif (isNaN(val)) {\n    node.warn('Ogiltigt vÃ¤rde frÃ¥n elmÃ¤tare: ' + msg.payload);\n    return null;\n}\n\n// Rimlighetskontroll (elmÃ¤tare brukar inte Ã¶verstiga 25 000W)\nif (Math.abs(val) > 25000) {\n    node.warn('Ovanligt hÃ¶gt effektvÃ¤rde: ' + val + 'W â€” kontrollera enhet (ska vara W, inte kW)');\n}\n\nmsg.topic = 'homeassistant/sensor/sgready_grid_power/state';\nmsg.payload = val.toFixed(1);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 400,
        "wires": [["sgready-mqtt-state"]]
    },
    {
        "id": "sgready-mqtt-state",
        "type": "mqtt out",
        "z": "sgready-tab",
        "name": "MQTT â†’ HA (effekt)",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "",
        "x": 660,
        "y": 400,
        "wires": []
    }
]
